<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apikeys.views &mdash; ForensicVM 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ForensicVM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ForensicVM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">apikeys.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for apikeys.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">ApiKey</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">CalledProcessError</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">ApiKey</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">asgiref.sync</span> <span class="kn">import</span> <span class="n">async_to_sync</span>
<span class="kn">from</span> <span class="nn">asgiref.sync</span> <span class="kn">import</span> <span class="n">sync_to_async</span>
<span class="kn">from</span> <span class="nn">apscheduler.schedulers.asyncio</span> <span class="kn">import</span> <span class="n">AsyncIOScheduler</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">asyncio</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">trollius</span> <span class="k">as</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseBadRequest</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">qemu.qmp</span> <span class="kn">import</span> <span class="n">QMPClient</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">FileResponse</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">isfile</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">recordings</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="CheckUserAuthenticatedView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckUserAuthenticatedView">[docs]</a><span class="k">class</span> <span class="nc">CheckUserAuthenticatedView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Django View class for checking if a user is authenticated.</span>

<span class="sd">    This class uses SessionAuthentication for user authentication.</span>
<span class="sd">    It doesn&#39;t implement any specific permission classes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    ----------</span>
<span class="sd">    authentication_classes : list</span>
<span class="sd">        List of authentication classes the view uses. Here, it&#39;s SessionAuthentication.</span>
<span class="sd">    permission_classes : list</span>
<span class="sd">        List of permission classes the view uses. Here, it&#39;s an empty list.</span>

<span class="sd">    Methods:</span>
<span class="sd">    -------</span>
<span class="sd">    get(request):</span>
<span class="sd">        Returns a JsonResponse indicating if a user is authenticated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CheckUserAuthenticatedView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckUserAuthenticatedView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles GET request to the view.</span>

<span class="sd">        This method retrieves a user from the request or an API key error if one occurred.</span>
<span class="sd">        It then checks if the user is authenticated by checking if any API key error occurred.</span>
<span class="sd">        If the user is authenticated, it returns a JSON response with the &#39;authenticated&#39; key set to True.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse that indicates if the user is authenticated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;authenticated&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="CheckUserAuthenticatedView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckUserAuthenticatedView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the authenticated user from the request or returns an API key error.</span>

<span class="sd">        This method attempts to get an authenticated user from the request.</span>
<span class="sd">        If the user is authenticated, it will return the user and None for the error.</span>
<span class="sd">        If the user is not authenticated, it will attempt to authenticate the user using an API key provided in the request.</span>
<span class="sd">        If the API key is valid and associated with an active user, it returns the user and None for the error.</span>
<span class="sd">        If the API key is invalid or the user associated with the key is not active, it returns None for the user and a JsonResponse indicating the error.</span>
<span class="sd">        If no API key is provided in the request, it returns None for the user and a JsonResponse indicating that an API key is required.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple where the first element is the authenticated user or None if no user could be authenticated,</span>
<span class="sd">            and the second element is None or a JsonResponse containing an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="DownloadVideoView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadVideoView">[docs]</a><span class="k">class</span> <span class="nc">DownloadVideoView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Django APIView class for downloading a video file.</span>

<span class="sd">    This class uses SessionAuthentication for user authentication.</span>
<span class="sd">    It doesn&#39;t implement any specific permission classes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    ----------</span>
<span class="sd">    authentication_classes : list</span>
<span class="sd">        List of authentication classes the view uses. Here, it&#39;s SessionAuthentication.</span>
<span class="sd">    permission_classes : list</span>
<span class="sd">        List of permission classes the view uses. Here, it&#39;s an empty list.</span>

<span class="sd">    Methods:</span>
<span class="sd">    -------</span>
<span class="sd">    get(request, uuid, filename):</span>
<span class="sd">        Returns a FileResponse to download a video file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DownloadVideoView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadVideoView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles GET request to download a video.</span>

<span class="sd">        This method checks if the user is authenticated, validates the filename,</span>
<span class="sd">        constructs the file path, checks if the file exists, and returns a FileResponse</span>
<span class="sd">        for the client to download the video.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>
<span class="sd">        uuid : str</span>
<span class="sd">            The unique identifier for the video file&#39;s directory.</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the video file to download.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.FileResponse</span>
<span class="sd">            A FileResponse that initiates the video file download.</span>

<span class="sd">        Raises:</span>
<span class="sd">        ------</span>
<span class="sd">        Http404</span>
<span class="sd">            If the video file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="c1"># Check filename to prevent directory traversal attacks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^[a-zA-Z0-9_.-]*$&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid filename&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">video_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/video&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">video_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;Video does not exist&quot;</span><span class="p">)</span>

        <span class="n">video_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">video_file</span><span class="p">)</span>
        <span class="c1">#response[&#39;Content-Disposition&#39;] = f&#39;attachment; filename*=UTF-8\&#39;\&#39;{urlquote(basename(filepath))}&#39;</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename*=UTF-8</span><span class="se">\&#39;\&#39;</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="DownloadVideoView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadVideoView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the authenticated user from the request or returns an API key error.</span>

<span class="sd">        This method attempts to get an authenticated user from the request.</span>
<span class="sd">        If the user is authenticated, it will return the user and None for the error.</span>
<span class="sd">        If the user is not authenticated, it will attempt to authenticate the user using an API key provided in the request.</span>
<span class="sd">        If the API key is valid and associated with an active user, it returns the user and None for the error.</span>
<span class="sd">        If the API key is invalid or the user associated with the key is not active, it returns None for the user and a JsonResponse indicating the error.</span>
<span class="sd">        If no API key is provided in the request, it returns None for the user and a JsonResponse indicating that an API key is required.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple where the first element is the authenticated user or None if no user could be authenticated,</span>
<span class="sd">            and the second element is None or a JsonResponse containing an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="ListVideosView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListVideosView">[docs]</a><span class="k">class</span> <span class="nc">ListVideosView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Django APIView class for listing all the .mp4 video files in a specific directory.</span>

<span class="sd">    This class uses SessionAuthentication for user authentication.</span>
<span class="sd">    It doesn&#39;t implement any specific permission classes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    ----------</span>
<span class="sd">    authentication_classes : list</span>
<span class="sd">        List of authentication classes the view uses. Here, it&#39;s SessionAuthentication.</span>
<span class="sd">    permission_classes : list</span>
<span class="sd">        List of permission classes the view uses. Here, it&#39;s an empty list.</span>

<span class="sd">    Methods:</span>
<span class="sd">    -------</span>
<span class="sd">    get(request, uuid):</span>
<span class="sd">        Returns a JsonResponse with a list of all .mp4 video files in the specified directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ListVideosView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListVideosView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles GET request to list all .mp4 video files in a specific directory.</span>

<span class="sd">        This method checks if the user is authenticated, constructs the video directory path,</span>
<span class="sd">        checks if the directory exists, and returns a JsonResponse containing a list of all .mp4 video files</span>
<span class="sd">        in the directory, sorted in ascending order.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>
<span class="sd">        uuid : str</span>
<span class="sd">            The unique identifier for the video files&#39; directory.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse containing a list of all .mp4 video files in the specified directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">video_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/video&quot;</span>
        <span class="c1">#video_exists = os.path.exists(video_dir)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Video directory not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">video_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">video_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">):</span>
                <span class="n">video_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">video_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;video_files&#39;</span><span class="p">:</span> <span class="n">video_files</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="ListVideosView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListVideosView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the authenticated user from the request or returns an API key error.</span>

<span class="sd">        This method attempts to get an authenticated user from the request.</span>
<span class="sd">        If the user is authenticated, it will return the user and None for the error.</span>
<span class="sd">        If the user is not authenticated, it will attempt to authenticate the user using an API key provided in the request.</span>
<span class="sd">        If the API key is valid and associated with an active user, it returns the user and None for the error.</span>
<span class="sd">        If the API key is invalid or the user associated with the key is not active, it returns None for the user and a JsonResponse indicating the error.</span>
<span class="sd">        If no API key is provided in the request, it returns None for the user and a JsonResponse indicating that an API key is required.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple where the first element is the authenticated user or None if no user could be authenticated,</span>
<span class="sd">            and the second element is None or a JsonResponse containing an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>

<span class="n">video_writers</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="create_video"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.create_video">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">create_video</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">output_video_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously create a video from screenshots taken in a virtual machine using QEMU Machine Protocol (QMP).</span>

<span class="sd">    The function connects to QMP, executes a screendump command to take a screenshot and saves it to a specified path.</span>
<span class="sd">    It then reads the screenshot into an image and writes the image as a frame to a video file.</span>
<span class="sd">    If the video writer is not yet set up, it initializes it with the size of the first frame.</span>
<span class="sd">    Once the frame has been written to the video, it removes the screenshot file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    uuid : str</span>
<span class="sd">        The unique identifier for the video file&#39;s directory.</span>
<span class="sd">    output_video_path : str</span>
<span class="sd">        The path where the output video will be saved.</span>

<span class="sd">    Raises:</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        Any exception that occurs while creating the video or connecting/disconnecting from QMP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>
    <span class="n">frame_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/frames&quot;</span>
    <span class="n">screenshot_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/frames/screenshot.ppm&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">frame_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">frame_path</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;screendump&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">screenshot_path</span><span class="p">})</span>

        <span class="c1"># Load screenshot as an image</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">)</span>

        <span class="c1"># If the video writer is not yet set up, initialize it with the size of the first frame</span>
        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">video_writers</span><span class="p">:</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;mp4v&#39;</span><span class="p">)</span>
            <span class="n">video_writers</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_video_path</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Video writer defined&quot;</span><span class="p">)</span>

        <span class="c1"># Write frame to video</span>
        <span class="n">video_writers</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>


        <span class="c1"># Remove screenshot</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>



<div class="viewcode-block" id="RecordVideoVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RecordVideoVMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecordVideoVMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Django View class that handles the video recording process of a virtual machine.</span>

<span class="sd">    This class implements the POST HTTP method to start and manage the recording of a video.</span>
<span class="sd">    If the requested virtual machine (identified by uuid) exists and is not already recording,</span>
<span class="sd">    it starts a new recording, creating a video file in a specified directory.</span>
<span class="sd">    The recording runs asynchronously for a maximum duration of three hours or until it is manually stopped.</span>

<span class="sd">    If the virtual machine is already recording, the POST request will return an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RecordVideoVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RecordVideoVMView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously handle a POST request to start recording a video.</span>

<span class="sd">        This method attempts to start a recording for the specified virtual machine.</span>
<span class="sd">        It checks if the machine exists and if a recording is not already in progress.</span>
<span class="sd">        If these conditions are met, it sets up a new video file and starts the recording.</span>
<span class="sd">        The recording runs for a maximum duration of three hours or until it is manually stopped.</span>
<span class="sd">        After the recording is finished, it cleans up the resources and sends a response indicating success.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>
<span class="sd">        uuid : str</span>
<span class="sd">            The unique identifier for the virtual machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        JsonResponse</span>
<span class="sd">            A JsonResponse indicating whether the recording started successfully or detailing any errors that occurred.</span>

<span class="sd">        Raises:</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            Any exception that occurs while starting or managing the recording.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">)(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">video_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/video/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>  <span class="c1"># Recreate the empty directory</span>

        <span class="n">video_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">video_path</span><span class="p">))</span>
        <span class="n">output_video_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;video</span><span class="si">{</span><span class="n">video_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.mp4&quot;</span><span class="p">)</span>

        <span class="n">video_writer</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Start with no video writer</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recordings</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;uuid not in the recordigs&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">recordings</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;uuid is in the recordings, but not in the uuid&quot;</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
            <span class="c1">#if uuid not in recordings:</span>
                <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">scheduler</span> <span class="o">=</span> <span class="n">AsyncIOScheduler</span><span class="p">()</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">create_video</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;create_video_job_</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">uuid</span><span class="p">,</span> <span class="n">output_video_path</span><span class="p">],</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1">#scheduler.add_job(create_video, &#39;interval&#39;, seconds=0.04, id=f&#39;create_video_job_{uuid}&#39;, args=[uuid, output_video_path, video_writer], replace_existing=True)</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># run the loop for 3600 interactions*3 (three hour)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># sleep for 1 second</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]:</span>  <span class="c1"># if recordings[uuid] is False, break the loop</span>
                        <span class="k">break</span>

                <span class="n">scheduler</span><span class="o">.</span><span class="n">remove_job</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;create_video_job_</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">video_writers</span><span class="p">:</span>
                    <span class="n">video_writers</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">video_writers</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span>  <span class="c1"># remove the VideoWriter from the dictionary</span>


                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;video_recorded&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Video recorded with the name video</span><span class="si">{</span><span class="n">video_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">.mp4&#39;</span><span class="p">}</span>
                <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

                <span class="c1">#return JsonResponse({&quot;status&quot;: &quot;Recording stopped&quot;}, status=200)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Recording already in progress&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="RecordVideoVMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RecordVideoVMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the user is authenticated or if there is an API key error.</span>

<span class="sd">        This method checks if the user associated with the request is authenticated.</span>
<span class="sd">        If the user is not authenticated, it checks if there&#39;s an API key in the request.</span>
<span class="sd">        If the API key is valid and associated with an active user, the method returns this user.</span>
<span class="sd">        If the API key is not valid or the user is not active, it returns a JSON response with the corresponding error.</span>
<span class="sd">        If there&#39;s no API key at all, it returns a JSON response indicating that the API key is required.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple where the first element is the authenticated user or None,</span>
<span class="sd">            and the second element is a JsonResponse with an error message or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>



<div class="viewcode-block" id="StopVideoRecordingVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopVideoRecordingVMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StopVideoRecordingVMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to handle the stoppage of video recording.</span>

<span class="sd">    The view uses session authentication and has no permission restrictions.</span>
<span class="sd">    The post method is used to handle the stoppage of the video recording for a VM with a given UUID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StopVideoRecordingVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopVideoRecordingVMView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a POST request to stop video recording for a VM with a given UUID.</span>

<span class="sd">        This method first checks if the user is authenticated or if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        If the UUID is present in the recordings, it stops the recording by setting the corresponding value to False.</span>
<span class="sd">        If the UUID is not present, it returns a HTTP 400 error.</span>
<span class="sd">        Finally, it returns a JSON response confirming the stoppage of the recording.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>
<span class="sd">        uuid : str</span>
<span class="sd">            The UUID of the VM for which the recording should be stopped.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">recordings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: Stop uuid in recordings&quot;</span><span class="p">)</span>
            <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No recording to stop for VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;video_recording_stopped&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Video recording stopped for VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="StopVideoRecordingVMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopVideoRecordingVMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the user is authenticated or if there is an API key error.</span>

<span class="sd">        This method checks if the user associated with the request is authenticated.</span>
<span class="sd">        If the user is not authenticated, it checks if there&#39;s an API key in the request.</span>
<span class="sd">        If the API key is valid and associated with an active user, the method returns this user.</span>
<span class="sd">        If the API key is not valid or the user is not active, it returns a JSON response with the corresponding error.</span>
<span class="sd">        If there&#39;s no API key at all, it returns a JSON response indicating that the API key is required.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple where the first element is the authenticated user or None,</span>
<span class="sd">            and the second element is a JsonResponse with an error message or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="CheckRecordingStatusVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckRecordingStatusVMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CheckRecordingStatusVMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to check the status of video recording.</span>

<span class="sd">    The view uses session authentication and has no permission restrictions.</span>
<span class="sd">    The get method is used to handle the checking of the video recording status for a VM with a given UUID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CheckRecordingStatusVMView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckRecordingStatusVMView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a GET request to check video recording status for a VM with a given UUID.</span>

<span class="sd">        This method first checks if the user is authenticated or if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        If the UUID is present in the recordings and is recording, it returns a JSON response indicating the recording is in progress.</span>
<span class="sd">        If the UUID is not present or not recording, it returns a JSON response indicating no recording is in progress.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>
<span class="sd">        uuid : str</span>
<span class="sd">            The UUID of the VM for which the recording status should be checked.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">recordings</span> <span class="ow">and</span> <span class="n">recordings</span><span class="p">[</span><span class="n">uuid</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_recording&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Recording is in progress for VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_recording&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No recording is in progress for VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="CheckRecordingStatusVMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckRecordingStatusVMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the user is authenticated or if there is an API key error.</span>

<span class="sd">        This method checks if the user associated with the request is authenticated.</span>
<span class="sd">        If the user is not authenticated, it checks if there&#39;s an API key in the request.</span>
<span class="sd">        If the API key is valid and associated with an active user, the method returns this user.</span>
<span class="sd">        If the API key is not valid or the user is not active, it returns a JSON response with the corresponding error.</span>
<span class="sd">        If there&#39;s no API key at all, it returns a JSON response indicating that the API key is required.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple where the first element is the authenticated user or None,</span>
<span class="sd">            and the second element is a JsonResponse with an error message or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="RemoveVMDateTimeView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RemoveVMDateTimeView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RemoveVMDateTimeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to remove the datetime line from a VM&#39;s configuration.</span>

<span class="sd">    The view has no authentication or permission restrictions.</span>
<span class="sd">    The post method is used to handle the removal of the datetime line from the configuration of a VM with a given UUID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RemoveVMDateTimeView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RemoveVMDateTimeView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a POST request to remove the datetime line from a VM&#39;s configuration.</span>

<span class="sd">        This method first checks if the user is authenticated or if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        The method then retrieves the UUID from the POST data.</span>
<span class="sd">        It locates the .vnc configuration file for the VM with the provided UUID, reads its content, and removes any line containing the &#39;-rtc base=&#39; string.</span>
<span class="sd">        If successful, the method returns a JSON response indicating the successful operation.</span>
<span class="sd">        If there&#39;s an error, it returns a JSON response with the error message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Get the user in the request</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>                          <span class="c1"># User is authenticated via session</span>
            <span class="k">pass</span>                                                    <span class="c1"># Add this extra block to the request</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>                                               <span class="c1"># &lt;--- Changed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Get the UUID from the POST data</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the .vnc file path</span>
            <span class="n">vnc_file_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/*vnc.sh&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Read the content of the file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vnc_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="c1"># Remove the -rtc base=&lt;datetime&gt; line if it exists</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="s1">&#39;-rtc base=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>

            <span class="c1"># Write the changes back to the file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vnc_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Date time line removed successfully for VM </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error updating VM date time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ChangeVMDateTimeView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ChangeVMDateTimeView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ChangeVMDateTimeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to change the datetime in a VM&#39;s configuration.</span>

<span class="sd">    The view has no authentication or permission restrictions.</span>
<span class="sd">    The post method is used to handle the updating of the datetime in the configuration of a VM with a given UUID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ChangeVMDateTimeView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ChangeVMDateTimeView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a POST request to change the datetime in a VM&#39;s configuration.</span>

<span class="sd">        This method first checks if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        The method then retrieves the UUID and the datetime from the POST data and validates the datetime format.</span>
<span class="sd">        If the datetime format is invalid, it returns a JSON response indicating the error.</span>
<span class="sd">        It locates the .sh configuration file for the VM with the provided UUID, reads its content, and changes or adds a line with the &#39;-rtc base=&#39; string and the new datetime.</span>
<span class="sd">        If successful, the method returns a JSON response indicating the successful operation.</span>
<span class="sd">        If there&#39;s an error, it returns a JSON response with the error message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>



        <span class="c1"># Get the UUID and datetime from the POST data</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span>

        <span class="c1"># Validate the datetime</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_date</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid datetime format&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the .sh file path</span>
            <span class="n">vnc_file_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/*vnc.sh&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Read the content of the file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vnc_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="c1"># Add the new line after the -vga section if it doesn&#39;t exist</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;-vga&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;-rtc base=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;    -rtc base=</span><span class="si">{</span><span class="n">datetime_str</span><span class="si">}</span><span class="s1"> </span><span class="se">\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;    -rtc base=</span><span class="si">{</span><span class="n">datetime_str</span><span class="si">}</span><span class="s1"> </span><span class="se">\\\n</span><span class="s1">&#39;</span>
                    <span class="k">break</span>

            <span class="c1"># Write the changes back to the file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vnc_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Date time </span><span class="si">{</span><span class="n">datetime_str</span><span class="si">}</span><span class="s1"> set successfully for VM </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error updating VM date time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="validate_date"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.validate_date">[docs]</a><span class="k">def</span> <span class="nf">validate_date</span><span class="p">(</span><span class="n">date_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to validate the date string against the format &#39;YYYY-MM-DDTHH:MM:SS&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DownloadNetworkPcapView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadNetworkPcapView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DownloadNetworkPcapView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to download the pcap files of a VM.</span>

<span class="sd">    The view has no authentication or permission restrictions.</span>
<span class="sd">    The get method is used to handle the downloading of pcap files of a VM with a given UUID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DownloadNetworkPcapView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadNetworkPcapView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a GET request to download the pcap files of a VM.</span>

<span class="sd">        This method first checks if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        The method then checks if the VM with the provided UUID exists.</span>
<span class="sd">        If the VM does not exist, it returns a JSON response indicating the error.</span>
<span class="sd">        It creates a zip file of all pcap files associated with the VM.</span>
<span class="sd">        If successful, the method returns a FileResponse with the created zip file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>
<span class="sd">        uuid : str</span>
<span class="sd">            The UUID of the VM.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.FileResponse</span>
<span class="sd">            A FileResponse with the zip file of the pcap files of the VM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">pcap_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/pcap/&quot;</span>

        <span class="c1"># Create a zip file containing all pcap files</span>
        <span class="n">zip_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/pcap.zip&quot;</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pcap_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pcap_path</span><span class="si">}</span><span class="s2">/*.pcap&quot;</span><span class="p">):</span>
                <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pcap_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pcap_file</span><span class="p">))</span>

        <span class="c1"># Return the zip file as a FileResponse</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">FileResponse</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/zip&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">return</span> <span class="n">response</span></div></div>



<div class="viewcode-block" id="CheckTapInterfaceView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckTapInterfaceView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CheckTapInterfaceView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to check the status of the tap interface of a VM.</span>

<span class="sd">    The view has no authentication or permission restrictions.</span>
<span class="sd">    The post method is used to handle the status checking of the tap interface of a VM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CheckTapInterfaceView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckTapInterfaceView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a POST request to check the status of the tap interface of a VM.</span>

<span class="sd">        This method first checks if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        The method then gets the UUID from the POST data and checks the status of the tap interface.</span>
<span class="sd">        It executes shell commands to get the tap interface and checks its status.</span>
<span class="sd">        If the tap interface is up, the method returns a JSON response with a positive status and message.</span>
<span class="sd">        If the tap interface is down, the method returns a JSON response with a negative status and message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse with the status and message about the status of the tap interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Get the uuid from the POST data</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;UUID required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># Execute the command to get the tap interface</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ps -ef | grep qemu | grep </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error finding QEMU process: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="n">tap_interface</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-netdev tap,id=u1,ifname=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Check the status of the tap interface</span>
        <span class="n">check_tap_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ifconfig </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">check_tap_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">check_tap_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">check_tap_output</span><span class="p">,</span> <span class="n">check_tap_error</span> <span class="o">=</span> <span class="n">check_tap_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">check_tap_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error checking tap interface: </span><span class="si">{</span><span class="n">check_tap_error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="n">is_up</span> <span class="o">=</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">in</span> <span class="n">check_tap_output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_up</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Tap interface </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s1"> is up&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Tap interface </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s1"> is down&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StartTapInterfaceView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StartTapInterfaceView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StartTapInterfaceView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to start the tap interface of a VM.</span>

<span class="sd">    The view authenticates the user with SessionAuthentication. The post method is used to handle the start request of</span>
<span class="sd">    the tap interface of a VM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>                <span class="c1"># ADDED</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StartTapInterfaceView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StartTapInterfaceView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a POST request to start the tap interface of a VM.</span>

<span class="sd">        This method first checks if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        The method then gets the UUID from the POST data and tries to start the tap interface.</span>
<span class="sd">        It executes shell commands to get the tap interface and starts it.</span>
<span class="sd">        If the tap interface starts successfully, the method returns a JSON response with a positive message.</span>
<span class="sd">        If there&#39;s an error while starting the tap interface, the method returns a JSON response with the error.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse with a message about the status of the tap interface start action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Authenticate user using API key</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="c1">#user = getattr(request, &#39;user&#39;, None)                       # IF sync</span>
        <span class="c1">#user = await sync_to_async(getattr)(request, &#39;user&#39;, None)  # ASYNC: Get the user in the request</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">get_user</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>                          <span class="c1"># User is authenticated via session</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="k">pass</span>                                                    <span class="c1"># Add this extra block to the request</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>                                               <span class="c1"># &lt;--- Changed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Get the uuid from the POST data</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuid</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no UUID sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;UUID required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># Execute the command to get the tap interface</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ps -ef | grep qemu | grep </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error finding QEMU process: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="n">tap_interface</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-netdev tap,id=u1,ifname=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Start the tap interface</span>
        <span class="n">start_tap_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ifconfig </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s2"> up&quot;</span>
        <span class="n">start_tap_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">start_tap_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">start_tap_output</span><span class="p">,</span> <span class="n">start_tap_error</span> <span class="o">=</span> <span class="n">start_tap_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">start_tap_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error starting tap interface: </span><span class="si">{</span><span class="n">start_tap_error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Tap interface </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s1"> started successfully&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="StopTapInterfaceView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopTapInterfaceView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StopTapInterfaceView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to stop the tap interface of a VM.</span>

<span class="sd">    The view authenticates the user with SessionAuthentication. The post method is used to handle the stop request of</span>
<span class="sd">    the tap interface of a VM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>                <span class="c1"># ADDED</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StopTapInterfaceView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopTapInterfaceView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a POST request to stop the tap interface of a VM.</span>

<span class="sd">        This method first checks if there is an API key error.</span>
<span class="sd">        If there&#39;s an API key error, it returns a JSON response with the error.</span>
<span class="sd">        The method then gets the UUID from the POST data and tries to stop the tap interface.</span>
<span class="sd">        It executes shell commands to get the tap interface and stops it.</span>
<span class="sd">        If the tap interface stops successfully, the method returns a JSON response with a positive message.</span>
<span class="sd">        If there&#39;s an error while stopping the tap interface, the method returns a JSON response with the error.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        request : django.http.HttpRequest</span>
<span class="sd">            The request instance for the current request.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        django.http.JsonResponse</span>
<span class="sd">            A JsonResponse with a message about the status of the tap interface stop action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Authenticate user using API key</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="c1">#user = getattr(request, &#39;user&#39;, None)                       # IF sync</span>
        <span class="c1">#user = await sync_to_async(getattr)(request, &#39;user&#39;, None)  # ASYNC: Get the user in the request</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">get_user</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>                          <span class="c1"># User is authenticated via session</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="k">pass</span>                                                    <span class="c1"># Add this extra block to the request</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>                                               <span class="c1"># &lt;--- Changed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Get the uuid from the POST data</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuid</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no UUID sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;UUID required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># Execute the command to get the tap interface</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ps -ef | grep qemu | grep </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error finding QEMU process: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="n">tap_interface</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-netdev tap,id=u1,ifname=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Start the tap interface</span>
        <span class="n">start_tap_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ifconfig </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s2"> down&quot;</span>
        <span class="n">start_tap_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">start_tap_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">start_tap_output</span><span class="p">,</span> <span class="n">start_tap_error</span> <span class="o">=</span> <span class="n">start_tap_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">start_tap_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error stopping tap interface: </span><span class="si">{</span><span class="n">start_tap_error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Tap interface </span><span class="si">{</span><span class="n">tap_interface</span><span class="si">}</span><span class="s1"> stopped successfully&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_available_memory"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.get_available_memory">[docs]</a><span class="k">def</span> <span class="nf">get_available_memory</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the current available system memory.</span>

<span class="sd">    This function uses the psutil library to fetch system memory information.</span>
<span class="sd">    It returns the amount of available memory in Megabytes.</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The amount of available system memory in Megabytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mem_info</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
    <span class="n">available_memory</span> <span class="o">=</span> <span class="n">mem_info</span><span class="o">.</span><span class="n">available</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span>  <span class="c1"># Convert to MB</span>
    <span class="k">return</span> <span class="n">available_memory</span></div>

<div class="viewcode-block" id="GetAvailableMemoryView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.GetAvailableMemoryView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GetAvailableMemoryView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles GET requests to retrieve available system memory.</span>

<span class="sd">    This view requires an API key for authentication. If the API key is valid</span>
<span class="sd">    and is associated with an active user, the system&#39;s available memory is returned.</span>
<span class="sd">    The available memory is calculated using the get_available_memory function.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, an error message is returned.</span>

<span class="sd">    The available memory is returned in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;available_memory&quot;: &lt;float&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GetAvailableMemoryView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.GetAvailableMemoryView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the GET request to retrieve the system&#39;s available memory.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains the available memory or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">available_memory</span> <span class="o">=</span> <span class="n">get_available_memory</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;available_memory&#39;</span><span class="p">:</span> <span class="n">available_memory</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ChangeMemorySizeView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ChangeMemorySizeView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ChangeMemorySizeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles POST requests to change the memory size of a Virtual Machine (VM).</span>

<span class="sd">    This view requires an API key for authentication and a POST body containing a new memory size.</span>
<span class="sd">    If the API key is valid and is associated with an active user, and the POST body contains a valid</span>
<span class="sd">    memory size, the script files in the VM directory are updated with the new memory size.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, or if the memory size</span>
<span class="sd">    is invalid, an error message is returned.</span>

<span class="sd">    The response indicates whether the memory size update was successful or not in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;message&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ChangeMemorySizeView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ChangeMemorySizeView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the POST request to change the memory size of a VM.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers and the new</span>
<span class="sd">                     memory size in the POST body.</span>
<span class="sd">            uuid: The UUID of the VM whose memory size is to be changed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains a success message or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Path for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">script_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_path</span><span class="p">,</span> <span class="s1">&#39;*.sh&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">script_files</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No script files found for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">recent_script_file</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">script_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">recent_script_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">script_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">memory_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;-m\s+(\d+)&#39;</span>
        <span class="n">new_memory_size</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_size&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_memory_size</span><span class="p">:</span>
            <span class="c1"># Update the memory parameter in the script content</span>
            <span class="n">updated_script_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">memory_pattern</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;-m </span><span class="si">{</span><span class="n">new_memory_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">script_content</span><span class="p">)</span>
            <span class="c1"># Write the updated script content back to the file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">recent_script_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">updated_script_content</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Memory size updated successfully&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or missing memory_size parameter&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span></div></div>


<span class="c1">#@method_decorator(csrf_exempt, name=&#39;dispatch&#39;)</span>
<div class="viewcode-block" id="MemorySizeView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.MemorySizeView">[docs]</a><span class="k">class</span> <span class="nc">MemorySizeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles GET requests to fetch the current memory size of a Virtual Machine (VM).</span>

<span class="sd">    This view requires an API key for authentication. If the API key is valid and is associated</span>
<span class="sd">    with an active user, the memory size is retrieved from the script files in the VM directory.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, or if the memory size</span>
<span class="sd">    cannot be found, an error message is returned.</span>

<span class="sd">    The response indicates either the memory size or an error message in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;memory_size&quot;: &lt;int&gt;</span>
<span class="sd">    }</span>
<span class="sd">    or</span>
<span class="sd">    {</span>
<span class="sd">        &quot;error&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MemorySizeView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.MemorySizeView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the GET request to fetch the memory size of a VM.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers.</span>
<span class="sd">            uuid: The UUID of the VM whose memory size is to be fetched.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains the memory size or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Path for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">script_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_path</span><span class="p">,</span> <span class="s1">&#39;*.sh&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">script_files</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No script files found for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">recent_script_file</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">script_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">recent_script_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">script_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">memory_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;-m\s+(\d+)&#39;</span>
        <span class="n">memory_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">memory_pattern</span><span class="p">,</span> <span class="n">script_content</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">memory_match</span><span class="p">:</span>
            <span class="n">memory_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">memory_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;memory_size&#39;</span><span class="p">:</span> <span class="n">memory_size</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Memory parameter not found in the script.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="delete_snapshot"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.delete_snapshot">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously delete a snapshot of a specific VM.</span>

<span class="sd">    This function uses QEMU&#39;s QMP (QEMU Machine Protocol) to execute commands on the VM.</span>
<span class="sd">    It specifically runs the `delvm` command to delete the snapshot.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid (str): The unique identifier for the VM.</span>
<span class="sd">        snapshot_name (str): The name of the snapshot to delete.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A message indicating whether the snapshot was successfully deleted or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;human-monitor-command&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;command-line&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;delvm </span><span class="si">{</span><span class="n">snapshot_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="s2">&quot;Snapshot deleted.&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Error deleting snapshot.&quot;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="DeleteSnapshotView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DeleteSnapshotView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DeleteSnapshotView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles POST requests to delete a snapshot of a specific VM.</span>

<span class="sd">    This view requires an API key for authentication. If the API key is valid and is associated</span>
<span class="sd">    with an active user, it calls the `delete_snapshot` asynchronous function to delete the snapshot.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, or if the snapshot</span>
<span class="sd">    name is missing in the request data, an error message is returned.</span>

<span class="sd">    The response indicates either a success or an error message in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;message&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    or</span>
<span class="sd">    {</span>
<span class="sd">        &quot;error&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="DeleteSnapshotView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DeleteSnapshotView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the POST request to delete a snapshot of a VM.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers,</span>
<span class="sd">                     and the snapshot name in the request data.</span>
<span class="sd">            uuid: The UUID of the VM whose snapshot is to be deleted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains a success message or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">snapshot_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snapshot_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Snapshot name required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

        <span class="n">delete_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">delete_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">delete_status</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="rollback_snapshot"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.rollback_snapshot">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">rollback_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously rollback to a snapshot of a specific VM.</span>

<span class="sd">    This function uses QEMU&#39;s QMP (QEMU Machine Protocol) to execute commands on the VM.</span>
<span class="sd">    It specifically runs the `loadvm` command to rollback to the snapshot.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid (str): The unique identifier for the VM.</span>
<span class="sd">        snapshot_name (str): The name of the snapshot to rollback to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A message indicating whether the snapshot was successfully rolled back or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;human-monitor-command&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;command-line&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;loadvm </span><span class="si">{</span><span class="n">snapshot_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="s2">&quot;Snapshot rollback successful.&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Error rolling back snapshot.&quot;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>

<div class="viewcode-block" id="RollbackSnapshotView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RollbackSnapshotView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RollbackSnapshotView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles POST requests to rollback a snapshot of a specific VM.</span>

<span class="sd">    This view requires an API key for authentication. If the API key is valid and is associated</span>
<span class="sd">    with an active user, it calls the `rollback_snapshot` asynchronous function to rollback to the snapshot.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, or if the snapshot</span>
<span class="sd">    name is missing in the request data, an error message is returned.</span>

<span class="sd">    The response indicates either a success or an error message in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;message&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    or</span>
<span class="sd">    {</span>
<span class="sd">        &quot;error&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RollbackSnapshotView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RollbackSnapshotView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the POST request to rollback to a snapshot of a VM.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers,</span>
<span class="sd">                     and the snapshot name in the request data.</span>
<span class="sd">            uuid: The UUID of the VM to rollback the snapshot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains a success message or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">snapshot_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snapshot_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Snapshot name required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

        <span class="n">rollback_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rollback_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">rollback_status</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="create_snapshot"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.create_snapshot">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">create_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously creates a snapshot of a specific VM.</span>

<span class="sd">    This function uses QEMU&#39;s QMP (QEMU Machine Protocol) to execute commands on the VM.</span>
<span class="sd">    It specifically runs the `savevm` command to create the snapshot.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid (str): The unique identifier for the VM.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The name of the snapshot if successful, or an error message if an exception occurred.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">snapshot_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;snap-%Y-%m-</span><span class="si">%d</span><span class="s2">_%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;human-monitor-command&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;command-line&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;savevm </span><span class="si">{</span><span class="n">snapshot_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">snapshot_name</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Error creating snapshot.&quot;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="CreateSnapshotView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CreateSnapshotView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CreateSnapshotView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles POST requests to create a snapshot of a specific VM.</span>

<span class="sd">    This view requires an API key for authentication. If the API key is valid and is associated</span>
<span class="sd">    with an active user, it calls the `create_snapshot` asynchronous function to create the snapshot.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, an error message is returned.</span>

<span class="sd">    The response indicates either the snapshot name or an error message in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;snapshot_name&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    or</span>
<span class="sd">    {</span>
<span class="sd">        &quot;error&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CreateSnapshotView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CreateSnapshotView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the POST request to create a snapshot of a VM.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers.</span>
<span class="sd">            uuid: The UUID of the VM to create the snapshot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains the snapshot name or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">snapshot_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;snapshot_name&#39;</span><span class="p">:</span> <span class="n">snapshot_name</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="get_snapshots"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.get_snapshots">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">get_snapshots</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously retrieves the list of snapshots of a specific VM.</span>

<span class="sd">    This function uses QEMU&#39;s QMP (QEMU Machine Protocol) to execute commands on the VM.</span>
<span class="sd">    It specifically runs the `info snapshots` command to retrieve the list of snapshots.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid (str): The unique identifier for the VM.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of dictionaries containing snapshot information. Each dictionary includes</span>
<span class="sd">              snapshot id, tag, VM size, date, and VM clock.</span>
<span class="sd">              If an exception occurred, an empty list is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>
    <span class="n">snapshots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;human-monitor-command&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;command-line&quot;</span><span class="p">:</span> <span class="s2">&quot;info snapshots&quot;</span>
        <span class="p">})</span>
        
        <span class="c1"># Assuming that result is a string with a table-like structure</span>
        <span class="n">snapshot_lines</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">snapshot_lines</span><span class="p">:</span>
            <span class="c1"># DEBUG</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">):</span>
                <span class="n">snapshot_info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">snapshot_id</span> <span class="o">=</span> <span class="n">snapshot_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">snapshot_tag</span> <span class="o">=</span> <span class="n">snapshot_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">vm_size</span> <span class="o">=</span> <span class="n">snapshot_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">snapshot_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">vm_clock</span> <span class="o">=</span> <span class="n">snapshot_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">snapshot_id</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">snapshot_tag</span><span class="p">,</span>
                    <span class="s1">&#39;vm_size&#39;</span><span class="p">:</span> <span class="n">vm_size</span><span class="p">,</span>
                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                    <span class="s1">&#39;vm_clock&#39;</span><span class="p">:</span> <span class="n">vm_clock</span>
                <span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">snapshots</span></div>

<div class="viewcode-block" id="SnapshotListView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.SnapshotListView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SnapshotListView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View that handles GET requests to retrieve the list of snapshots of a specific VM.</span>

<span class="sd">    This view requires an API key for authentication. If the API key is valid and is associated</span>
<span class="sd">    with an active user, it calls the `get_snapshots` asynchronous function to retrieve the list of snapshots.</span>

<span class="sd">    If the API key is missing, invalid, or associated with an inactive user, an error message is returned.</span>

<span class="sd">    The response includes a list of snapshots or an error message in a JSON format:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;snapshots&quot;: [&lt;list of snapshots&gt;]</span>
<span class="sd">    }</span>
<span class="sd">    or</span>
<span class="sd">    {</span>
<span class="sd">        &quot;error&quot;: &lt;string&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SnapshotListView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.SnapshotListView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the GET request to retrieve the list of snapshots of a VM.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request from the client. Expected to contain the API key in the headers.</span>
<span class="sd">            uuid: The UUID of the VM to get the snapshots.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonResponse: A JsonResponse that either contains the list of snapshots or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">snapshots</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_snapshots</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;snapshots&#39;</span><span class="p">:</span> <span class="n">snapshots</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="create_and_format_qcow2"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.create_and_format_qcow2">[docs]</a><span class="k">def</span> <span class="nf">create_and_format_qcow2</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">,</span> <span class="n">folders</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and formats a new QCOW2 file with a capacity of 20GB, and initializes it with a new NTFS partition.</span>

<span class="sd">    This function first creates a new QCOW2 file using the `qemu-img` command. Then, it initializes a new NTFS partition on</span>
<span class="sd">    the QCOW2 file using the `guestfish` command-line tool.</span>

<span class="sd">    After the partition is created, the function creates a series of folders in the root directory of the partition.</span>
<span class="sd">    Finally, it writes a readme file in the root directory of the partition.</span>

<span class="sd">    Args:</span>
<span class="sd">        qcow2_file (str): The path where the new QCOW2 file will be created.</span>
<span class="sd">        folders (list): A list of folder names that will be created in the root directory of the NTFS partition.</span>

<span class="sd">    Raises:</span>
<span class="sd">        subprocess.CalledProcessError: If the `qemu-img` command or the `guestfish` command fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a new QCOW2 file with 20GB of space</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;qemu-img&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;qcow2&#39;</span><span class="p">,</span> <span class="n">qcow2_file</span><span class="p">,</span> <span class="s1">&#39;20G&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Name for the label</span>
    <span class="n">label_name</span> <span class="o">=</span> <span class="s2">&quot;possible evidence&quot;</span>

    <span class="c1"># Create a new NTFS partition with guestfish</span>
    <span class="n">guestfish_commands</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    launch</span>
<span class="s2">    part-init /dev/sda mbr</span>
<span class="s2">    part-add /dev/sda p 2048 -1024</span>
<span class="s2">    part-set-mbr-id /dev/sda 1 0x07</span>
<span class="s2">    mkfs ntfs /dev/sda1</span>
<span class="s2">    set-label /dev/sda1 &quot;</span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">    mount /dev/sda1 /</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Create folders using guestfish</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="n">guestfish_commands</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mkdir /</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="n">guestfish_commands</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    umount /</span>
<span class="s2">    &quot;&quot;&quot;</span>



    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;guestfish --rw -a </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s2"> &lt;&lt;EOF</span><span class="se">\n</span><span class="si">{</span><span class="n">guestfish_commands</span><span class="si">}</span><span class="se">\n</span><span class="s2">EOF</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">guestfish_commands</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    launch</span>
<span class="s2">    mount /dev/sda1 /</span>
<span class="s2">    write /readme.txt </span><span class="se">\&quot;</span><span class="s2">Forensic VM: This drive was automaticaly created. Please put the probable evidence inside the sub-folders with the same tag of autopsy software for the easiest classification</span><span class="se">\&quot;</span>
<span class="s2">    write /leiame.txt </span><span class="se">\&quot;</span><span class="s2">Forensic VM: Este disco foi criado automticamente. Para facilitar a classificao, por favor coloque as evidncias recolhidas nas subpastas que tm o mesmo nome que a etiqueta no software autopsy</span><span class="se">\&quot;</span>
<span class="s2">    umount /</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;guestfish --rw -a </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s2"> &lt;&lt;EOF</span><span class="se">\n</span><span class="si">{</span><span class="n">guestfish_commands</span><span class="si">}</span><span class="se">\n</span><span class="s2">EOF</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;END guestfish&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="RecreateFoldersView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RecreateFoldersView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecreateFoldersView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django view handles POST requests to recreate a set of folders inside a QCOW2 file in a Virtual Machine.</span>

<span class="sd">    The view first authenticates the request based on the provided API key. If the user related to the API key is not active,</span>
<span class="sd">    it returns an error.</span>

<span class="sd">    Upon successful authentication, the view retrieves a list of folders and a VM uuid from the request. It then creates</span>
<span class="sd">    a new QCOW2 file in the corresponding VM directory and formats it with NTFS filesystem, followed by creating the specified</span>
<span class="sd">    folders in the root directory of the filesystem. If the QCOW2 file already exists, it is first deleted.</span>

<span class="sd">    If the QCOW2 file is created and formatted successfully, the view returns a success message. If an error occurs during</span>
<span class="sd">    the operation, it returns an error message.</span>

<span class="sd">    The view uses the `create_and_format_qcow2` function to perform the creation and formatting operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RecreateFoldersView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RecreateFoldersView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Get the list of folders from the POST data</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;folders&#39;</span><span class="p">)</span>
        <span class="n">uuid_path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid_path&#39;</span><span class="p">)</span>
        <span class="n">qcow2_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid_path</span><span class="si">}</span><span class="s2">/evidence.qcow2&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Remove existing qcow2_file if it exists</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">)</span>

            <span class="c1"># Create and format the Qcow2 file</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before create qcow2&quot;</span><span class="p">)</span>
            <span class="n">create_and_format_qcow2</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">,</span> <span class="n">folders</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;after create qcow2&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Folders </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span><span class="si">}</span><span class="s1"> created successfully in </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error executing guestfish: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RunPluginView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RunPluginView">[docs]</a><span class="k">class</span> <span class="nc">RunPluginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django view handles GET requests to run a forensic plugin script on a specified image within a Virtual Machine.</span>

<span class="sd">    The view first authenticates the request based on the provided API key. If the user related to the API key is not active,</span>
<span class="sd">    it returns an error.</span>

<span class="sd">    Upon successful authentication, the view retrieves the plugin directory and VM uuid from the request parameters.</span>
<span class="sd">    It validates the existence of the plugin script and the image, both identified using the provided parameters.</span>

<span class="sd">    If the validation is successful, it attempts to run the plugin script on the image and returns the script&#39;s stdout as</span>
<span class="sd">    the response. If the script fails to run, the error details are returned in the response.</span>

<span class="sd">    If the validation fails because of the non-existence of the plugin script or the image, an appropriate error message is returned.</span>

<span class="sd">    This view does not require any special permissions or authentication classes, as it is intended to be used internally</span>
<span class="sd">    by the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RunPluginView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RunPluginView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles GET requests to execute a specific forensic plugin on a VM image.</span>

<span class="sd">        The method retrieves the API key from the request headers and validates it. If the API key is invalid or</span>
<span class="sd">        belongs to an inactive user, an error response is returned.</span>

<span class="sd">        The method retrieves the plugin directory and image UUID from the GET parameters. It validates these parameters</span>
<span class="sd">        by checking the existence of the plugin script and the image path. If any of these does not exist, an error response is returned.</span>

<span class="sd">        The method looks for the latest &#39;.qcow2-sda&#39; file within the image path and sets it as the target for the plugin.</span>

<span class="sd">        Upon successful validation, the method attempts to run the plugin script on the image using a bash subprocess. The output</span>
<span class="sd">        from the subprocess is returned in the response.</span>

<span class="sd">        If the plugin script execution fails, the error details are returned in the response.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing either the output of the plugin execution or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">plugin_directory</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plugin_directory&#39;</span><span class="p">)</span>
        <span class="n">image_uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_uuid&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plugin_directory</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">image_uuid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing plugin_directory or image_uuid&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">plugin_script_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/forensicVM/plugins/</span><span class="si">{</span><span class="n">plugin_directory</span><span class="si">}</span><span class="s1">/run.sh&#39;</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">image_uuid</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_script_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Plugin script not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Image path not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.qcow2-sda&#39;</span><span class="p">):</span>
                <span class="n">image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Image file not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="n">plugin_script_path</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Plugin execution failed: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ListPluginsView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListPluginsView">[docs]</a><span class="k">class</span> <span class="nc">ListPluginsView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django REST Framework view that extends from the APIView base class.</span>

<span class="sd">    The ListPluginsView class defines behavior for handling HTTP GET requests on the URL path associated with it.</span>
<span class="sd">    The purpose of this class is to provide an endpoint that responds with a list of available forensic plugins.</span>
<span class="sd">    The view uses Django&#39;s APIView, which means it can handle different types of HTTP requests.</span>
<span class="sd">    It currently only implements handling of GET requests via the defined get() method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use. Empty in this case.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. Empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ListPluginsView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListPluginsView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles GET requests to list all available forensic plugins.</span>

<span class="sd">        The method retrieves the API key from the request headers and validates it. If the API key is invalid or</span>
<span class="sd">        belongs to an inactive user, an error response is returned.</span>

<span class="sd">        The method then reads the &#39;plugins&#39; directory and looks for &#39;run.sh&#39; files in each of the subdirectories.</span>
<span class="sd">        For each such file found, it gets the plugin information by calling the get_plugin_info() function.</span>

<span class="sd">        If the &#39;plugins&#39; directory does not exist, an error response is returned.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a list of all available plugins with their names, descriptions and directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

        <span class="n">plugins_dir</span> <span class="o">=</span> <span class="s1">&#39;/forensicVM/plugins&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Plugins directory not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">plugin_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;run.sh&#39;</span><span class="p">:</span>
                    <span class="n">plugin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)))</span>
                    <span class="n">plugin_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;plugin_name&#39;</span><span class="p">:</span> <span class="n">get_plugin_info</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">,</span> <span class="s1">&#39;plugin_name&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;plugin_description&#39;</span><span class="p">:</span> <span class="n">get_plugin_info</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">,</span> <span class="s1">&#39;plugin_description&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;plugin_dir&#39;</span><span class="p">:</span> <span class="n">plugin_dir</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;plugins&#39;</span><span class="p">:</span> <span class="n">plugin_files</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_plugin_info"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.get_plugin_info">[docs]</a><span class="k">def</span> <span class="nf">get_plugin_info</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the &#39;info&#39; command of the plugin script and retrieves the specified information.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    plugin_dir (str): The directory where the plugin script is located.</span>
<span class="sd">    info (str): The type of information to retrieve (e.g. &#39;plugin_name&#39;, &#39;plugin_description&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The requested information, or an empty string if the information could not be retrieved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/forensicVM/plugins&#39;</span><span class="p">,</span> <span class="n">plugin_dir</span><span class="p">,</span> <span class="s1">&#39;run.sh&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="n">run_script_path</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="n">info_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="insert_network_card"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.insert_network_card">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">insert_network_card</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">mac_address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously inserts a network card into a specified virtual machine.</span>

<span class="sd">    This function first generates a random MAC address if none is provided. It then establishes a connection to</span>
<span class="sd">    the QEMU Machine Protocol (QMP) and sends commands to add a new network device to the machine.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    uuid (str): The unique identifier of the virtual machine.</span>
<span class="sd">    mac_address (str, optional): The MAC address to assign to the network card.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: A confirmation message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mac_address</span><span class="p">:</span>
        <span class="c1"># Generate a random MAC address if not supplied</span>
        <span class="n">mac_address</span> <span class="o">=</span> <span class="n">generate_random_mac_address</span><span class="p">()</span>

    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;netdev_add&quot;</span><span class="p">,</span>
                                <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;net0&quot;</span><span class="p">})</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;device_add&quot;</span><span class="p">,</span>
                                <span class="p">{</span> <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio-net-pci&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;netdev&quot;</span><span class="p">:</span> <span class="s2">&quot;net0&quot;</span><span class="p">})</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;query-pci&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network card inserted with MAC address: </span><span class="si">{</span><span class="n">mac_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">return</span> <span class="s2">&quot;Network card inserted.&quot;</span></div>

<div class="viewcode-block" id="generate_random_mac_address"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.generate_random_mac_address">[docs]</a><span class="k">def</span> <span class="nf">generate_random_mac_address</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a random MAC address.</span>

<span class="sd">    This function creates a MAC address with the locally administered and unicast bits set,</span>
<span class="sd">    and with the rest of the bits randomized.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The generated MAC address.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">random</span>

    <span class="n">mac</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
           <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">),</span>
           <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">),</span>
           <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)]</span>

    <span class="n">mac_address</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%02x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">mac</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mac_address</span></div>

<div class="viewcode-block" id="InsertNetworkCardView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.InsertNetworkCardView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">InsertNetworkCardView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django view that provides an endpoint for inserting a network card into a virtual machine.</span>

<span class="sd">    The InsertNetworkCardView class handles HTTP GET requests to insert a network card into a virtual machine</span>
<span class="sd">    identified by its unique identifier (uuid). The class uses Django&#39;s View, which means it can handle different types</span>
<span class="sd">    of HTTP requests. It currently only implements handling of GET requests via the defined get() method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use. Empty in this case.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. Empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="InsertNetworkCardView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.InsertNetworkCardView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the GET request to insert a network card into a virtual machine.</span>

<span class="sd">        It first validates the API key from the request. If the key is valid, it calls the asynchronous function</span>
<span class="sd">        insert_network_card() to insert the network card and returns a confirmation message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>
<span class="sd">        uuid (str): The unique identifier of the virtual machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a confirmation message or an error message with an HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#api_key = ApiKey.objects.get(key=api_key)</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;User account disabled&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid key&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;api required&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuid</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;uuid required&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;UUID is required.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inserting network card&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">insert_network_card</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inserted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Network card inserted.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="insert_cdrom"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.insert_cdrom">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">insert_cdrom</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously inserts a CD-ROM into a specified virtual machine.</span>

<span class="sd">    This function establishes a connection to the QEMU Machine Protocol (QMP) and sends a command to change the medium</span>
<span class="sd">    of the CD-ROM drive to the specified ISO file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    uuid (str): The unique identifier of the virtual machine.</span>
<span class="sd">    filename (str): The name of the ISO file to insert into the CD-ROM drive.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: A confirmation message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;blockdev-change-medium&quot;</span><span class="p">,</span>
                                <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;ide0-0-0&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/iso/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span> <span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CD-ROM inserted.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">return</span> <span class="s2">&quot;CD-ROM inserted.&quot;</span></div>


<div class="viewcode-block" id="InsertCDROMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.InsertCDROMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">InsertCDROMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django view that provides an endpoint for inserting a CD-ROM into a virtual machine.</span>

<span class="sd">    The InsertCDROMView class handles HTTP GET requests to insert a CD-ROM into a virtual machine</span>
<span class="sd">    identified by its unique identifier (uuid) and the filename of the ISO image.</span>

<span class="sd">    The class uses Django&#39;s View, which means it can handle different types of HTTP requests. It currently only</span>
<span class="sd">    implements handling of GET requests via the defined get() method. It also supports authentication via sessions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use.</span>
<span class="sd">                                       It includes SessionAuthentication.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. Empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="InsertCDROMView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.InsertCDROMView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the GET request to insert a CD-ROM into a virtual machine.</span>

<span class="sd">        It first validates the user or API key from the request. If the user is authenticated or the API key is valid,</span>
<span class="sd">        it calls the asynchronous function insert_cdrom() to insert the CD-ROM and returns a confirmation message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>
<span class="sd">        uuid (str): The unique identifier of the virtual machine.</span>
<span class="sd">        filename (str): The filename of the ISO image to insert into the CD-ROM drive.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a confirmation message or an error message with an HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">cdrom_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">insert_cdrom</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">cdrom_status</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="InsertCDROMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.InsertCDROMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the user authentication and API key validation.</span>

<span class="sd">        It checks if the user is authenticated. If not, it validates the API key from the request. If the API key</span>
<span class="sd">        is invalid or belongs to an inactive user, it returns a JSON response with an error message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        tuple: A tuple containing the user (if authenticated or API key is valid) and a JSON response (if any error occurs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="eject_cdrom"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.eject_cdrom">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">eject_cdrom</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously ejects the CD-ROM from a specified virtual machine.</span>

<span class="sd">    This function establishes a connection to the QEMU Machine Protocol (QMP) and sends a command to open the tray</span>
<span class="sd">    of the CD-ROM drive, effectively ejecting the CD-ROM.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    uuid (str): The unique identifier of the virtual machine.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: A confirmation message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;blockdev-open-tray&quot;</span><span class="p">,</span>
                                <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;ide0-0-0&quot;</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CD-ROM ejected.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">return</span> <span class="s2">&quot;CD-ROM ejected.&quot;</span></div>

<div class="viewcode-block" id="EjectCDROMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.EjectCDROMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EjectCDROMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django view that provides an endpoint for ejecting the CD-ROM from a virtual machine.</span>

<span class="sd">    The EjectCDROMView class handles HTTP GET requests to eject the CD-ROM from a virtual machine</span>
<span class="sd">    identified by its unique identifier (uuid).</span>

<span class="sd">    The class uses Django&#39;s View, which means it can handle different types of HTTP requests. It currently only</span>
<span class="sd">    implements handling of GET requests via the defined get() method. It also supports authentication via sessions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use.</span>
<span class="sd">                                       It includes SessionAuthentication.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. Empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="EjectCDROMView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.EjectCDROMView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the GET request to eject the CD-ROM from a virtual machine.</span>

<span class="sd">        It first validates the user or API key from the request. If the user is authenticated or the API key is valid,</span>
<span class="sd">        it calls the asynchronous function eject_cdrom() to eject the CD-ROM and returns a confirmation message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>
<span class="sd">        uuid (str): The unique identifier of the virtual machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a confirmation message or an error message with an HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">cdrom_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">eject_cdrom</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">cdrom_status</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="EjectCDROMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.EjectCDROMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the user authentication and API key validation.</span>

<span class="sd">        It checks if the user is authenticated. If not, it validates the API key from the request. If the API key</span>
<span class="sd">        is invalid or belongs to an inactive user, it returns a JSON response with an error message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        tuple: A tuple containing the user (if authenticated or API key is valid) and a JSON response (if any error occurs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="DeleteISOFileView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DeleteISOFileView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DeleteISOFileView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django view that provides an endpoint for deleting an ISO file from a specified directory.</span>

<span class="sd">    The DeleteISOFileView class handles HTTP POST requests to delete an ISO file identified by its filename.</span>

<span class="sd">    The class uses Django&#39;s View, which means it can handle different types of HTTP requests. It currently only</span>
<span class="sd">    implements handling of POST requests via the defined post() method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use. It&#39;s empty in this case.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. It&#39;s empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DeleteISOFileView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DeleteISOFileView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the POST request to delete an ISO file.</span>

<span class="sd">        It first validates the API key from the request. If the API key is valid and belongs to an active user,</span>
<span class="sd">        it checks if the ISO directory and the specified ISO file exist. If they do, it deletes the ISO file</span>
<span class="sd">        and returns a confirmation message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>
<span class="sd">        filename (str): The name of the ISO file to be deleted.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a confirmation message or an error message with an HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">iso_dir</span> <span class="o">=</span> <span class="s1">&#39;/forensicVM/mnt/iso&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iso_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;ISO directory not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">iso_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iso_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">iso_file_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;ISO file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">iso_file_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;ISO file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> deleted successfully&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UploadISOView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.UploadISOView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UploadISOView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django view that provides an endpoint for uploading an ISO file to a specified directory.</span>

<span class="sd">    The UploadISOView class handles HTTP POST requests to receive an ISO file and save it to the directory.</span>

<span class="sd">    The class uses Django&#39;s View, which means it can handle different types of HTTP requests. It currently only</span>
<span class="sd">    implements handling of POST requests via the defined post() method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use. It&#39;s empty in this case.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. It&#39;s empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="UploadISOView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.UploadISOView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the POST request to upload an ISO file.</span>

<span class="sd">        It first validates the API key from the request. If the API key is valid and belongs to an active user,</span>
<span class="sd">        it checks if an ISO file is provided in the request. If it is, it saves the ISO file</span>
<span class="sd">        to a specified directory and returns a confirmation message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a confirmation message or an error message with an HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">iso_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;iso_file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iso_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing ISO file&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># Save the ISO file to the target directory</span>
        <span class="n">upload_dir</span> <span class="o">=</span> <span class="s1">&#39;/forensicVM/mnt/iso&#39;</span>
        <span class="n">iso_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">iso_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">iso_file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">iso_file</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;ISO file uploaded successfully&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ListISOFilesView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListISOFilesView">[docs]</a><span class="k">class</span> <span class="nc">ListISOFilesView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a Django view that provides an endpoint for retrieving a list of all ISO files in a specified directory.</span>

<span class="sd">    The ListISOFilesView class handles HTTP GET requests to retrieve the ISO files.</span>

<span class="sd">    The class uses Django&#39;s APIView, which allows it to handle different types of HTTP requests. It currently only</span>
<span class="sd">    implements handling of GET requests via the defined get() method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        authentication_classes (list): A list of authentication classes the view should use. It&#39;s empty in this case.</span>
<span class="sd">        permission_classes (list): A list of permissions the view should enforce. It&#39;s empty in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ListISOFilesView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ListISOFilesView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the GET request to list all ISO files.</span>

<span class="sd">        It first validates the API key from the request. If the API key is valid and belongs to an active user,</span>
<span class="sd">        it checks if the ISO directory exists and retrieves a list of all ISO files in the directory. If the directory</span>
<span class="sd">        does not exist, it returns an error message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a list of all ISO files in the directory or an error message with an HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">iso_dir</span> <span class="o">=</span> <span class="s1">&#39;/forensicVM/mnt/iso&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iso_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;ISO directory not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">iso_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">iso_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.iso&#39;</span><span class="p">):</span>
                <span class="n">iso_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;iso_files&#39;</span><span class="p">:</span> <span class="n">iso_files</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="change_qcow2"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.change_qcow2">[docs]</a><span class="k">def</span> <span class="nf">change_qcow2</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">,</span> <span class="n">folders</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates new folders in a qcow2 disk image. It uses guestfish commands to interact with the disk image.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    qcow2_file (str): Path to the qcow2 file that should be changed.</span>
<span class="sd">    folders (list): List of folder names to be created in the qcow2 image.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>

<span class="sd">    Raises:</span>
<span class="sd">    subprocess.CalledProcessError: If a guestfish command fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a new NTFS partition with guestfish</span>
    <span class="n">guestfish_commands</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    launch</span>
<span class="s2">    mount /dev/sda1 /</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Create folders using guestfish</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="n">guestfish_commands</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-mkdir /</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="n">guestfish_commands</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    umount /</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;guestfish --rw -a </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s2"> &lt;&lt;EOF</span><span class="se">\n</span><span class="si">{</span><span class="n">guestfish_commands</span><span class="si">}</span><span class="se">\n</span><span class="s2">EOF</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">guestfish_commands</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    launch</span>
<span class="s2">    mount /dev/sda1 /</span>
<span class="s2">    write /readme.txt </span><span class="se">\&quot;</span><span class="s2">Forensic VM: This drive was automaticaly created. Please put the probable evidence inside the sub-folders with the same tag of autopsy software for the easiest classification</span><span class="se">\&quot;</span>
<span class="s2">    write /leiame.txt </span><span class="se">\&quot;</span><span class="s2">Forensic VM: Este disco foi criado automticamente. Para facilitar a classificao, por favor coloque as evidncias recolhidas nas subpastas que tm o mesmo nome que a etiqueta no software autopsy</span><span class="se">\&quot;</span>
<span class="s2">    umount /</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;guestfish -x --rw -a </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s2"> &lt;&lt;EOF</span><span class="se">\n</span><span class="si">{</span><span class="n">guestfish_commands</span><span class="si">}</span><span class="se">\n</span><span class="s2">EOF</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;END guestfish&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CreateFoldersView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CreateFoldersView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CreateFoldersView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      This class-based view handles the POST request to create specified folders in a qcow2 disk image.</span>

<span class="sd">      The method checks the validity and activity status of the provided API key. If the API key is invalid or</span>
<span class="sd">      belongs to an inactive user, it returns an error message.</span>

<span class="sd">      It then retrieves the list of folders and the UUID path from the request data. It uses the UUID path to form</span>
<span class="sd">      the path to the qcow2 file.</span>

<span class="sd">      It checks if the qcow2 file exists. If it doesn&#39;t, it returns an error.</span>

<span class="sd">      It calls the change_qcow2 function to create the folders in the qcow2 file. If successful, it returns a success</span>
<span class="sd">      message. If an error occurs, it returns an error message.</span>

<span class="sd">      Attributes:</span>
<span class="sd">      authentication_classes (list): A list of authentication classes to use for the view.</span>
<span class="sd">      permission_classes (list): A list of permission classes to use for the view.</span>

<span class="sd">      Methods:</span>
<span class="sd">      post(request): Asynchronously handles the POST request.</span>
<span class="sd">      &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CreateFoldersView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CreateFoldersView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously handles the POST request to create folders in a qcow2 file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        JsonResponse: A JSON object containing a success message if the folders were created successfully,</span>
<span class="sd">                       or an error message otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Get the list of folders from the POST data</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;folders&#39;</span><span class="p">)</span>
        <span class="n">uuid_path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid_path&#39;</span><span class="p">)</span>
        <span class="n">qcow2_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid_path</span><span class="si">}</span><span class="s2">/evidence.qcow2&quot;</span>

        <span class="c1"># Check if vmdk_file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;QCOW2 file </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">change_qcow2</span><span class="p">(</span><span class="n">qcow2_file</span><span class="p">,</span> <span class="n">folders</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Folders </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span><span class="si">}</span><span class="s1"> created successfully in </span><span class="si">{</span><span class="n">qcow2_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error executing guestfish: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DownloadEvidenceView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadEvidenceView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DownloadEvidenceView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class-based view handles the GET request to download a VMDK evidence file related to a specific VM.</span>

<span class="sd">    The method checks the validity and activity status of the provided API key. If the API key is invalid or</span>
<span class="sd">    belongs to an inactive user, it returns an error message.</span>

<span class="sd">    It uses the UUID from the URL parameters to form the path to the VM directory and checks if it exists.</span>

<span class="sd">    It then forms the path to the qcow2 file and converts it to a VMDK file using qemu-img. If this process fails,</span>
<span class="sd">    it returns an error message.</span>

<span class="sd">    It checks if the VMDK evidence file exists. If it doesn&#39;t, it returns an error.</span>

<span class="sd">    Finally, it returns the evidence file as a FileResponse, allowing the client to download it.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    authentication_classes (list): A list of authentication classes to use for the view.</span>
<span class="sd">    permission_classes (list): A list of permission classes to use for the view.</span>

<span class="sd">    Methods:</span>
<span class="sd">    get(request, uuid): Asynchronously handles the GET request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DownloadEvidenceView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadEvidenceView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously handles the GET request to download a VMDK evidence file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        request (HttpRequest): The request object that has triggered this method.</span>
<span class="sd">        uuid (str): The UUID of the VM.</span>

<span class="sd">        Returns:</span>
<span class="sd">        FileResponse: A FileResponse object containing the VMDK evidence file,</span>
<span class="sd">                      or a JsonResponse object containing an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">evidence_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/evidence.vmdk&quot;</span>
        <span class="n">qcow2_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/evidence.qcow2&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;qemu-img convert </span><span class="si">{</span><span class="n">qcow2_path</span><span class="si">}</span><span class="s2"> -f qcow2 -O vmdk </span><span class="si">{</span><span class="n">evidence_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;folder_mounted&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error converting evidence disk: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="n">evidence_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">evidence_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">evidence_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Evidence file not found for VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="c1"># Return the evidence file as a FileResponse</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">FileResponse</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">evidence_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">evidence_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">return</span> <span class="n">response</span></div></div>

<div class="viewcode-block" id="memory_snapshot"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.memory_snapshot">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">memory_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This asynchronous function captures a snapshot of a VM&#39;s memory.</span>

<span class="sd">    It establishes a connection with the QEMU Machine Protocol (QMP) running on the VM,</span>
<span class="sd">    then uses the QMP command &#39;dump-guest-memory&#39; to capture the memory snapshot.</span>

<span class="sd">    The function saves the memory snapshot to the VM&#39;s directory, with a unique filename</span>
<span class="sd">    based on the current number of existing snapshots.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    uuid (str): The UUID of the VM.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The path to the newly created memory snapshot file.</span>

<span class="sd">    Raises:</span>
<span class="sd">    Exception: If there&#39;s an error executing the &#39;dump-guest-memory&#39; command or disconnecting from QMP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>
    <span class="n">memory_snapshots_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/memory/&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">memory_snapshots_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">memory_snapshots_path</span><span class="p">)</span>

    <span class="n">existing_snapshots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory_snapshots_path</span><span class="si">}</span><span class="s2">/memory_snapshot*.dmp&quot;</span><span class="p">))</span>
    <span class="n">next_snapshot_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_snapshots</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">next_snapshot_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;memory_snapshot</span><span class="si">{</span><span class="n">next_snapshot_number</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">.dmp&quot;</span>
    <span class="n">next_snapshot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">memory_snapshots_path</span><span class="p">,</span> <span class="n">next_snapshot_filename</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;dump-guest-memory&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;paging&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;file:</span><span class="si">{</span><span class="n">next_snapshot_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;detach&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory snapshot saved: </span><span class="si">{</span><span class="n">next_snapshot_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">next_snapshot_path</span></div>

<div class="viewcode-block" id="MemorySnapshotView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.MemorySnapshotView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MemorySnapshotView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an API view for creating a memory snapshot of a Virtual Machine (VM) and downloading it.</span>
<span class="sd">    It requires the UUID of the VM to be specified as a path parameter in the URL.</span>

<span class="sd">    Authentication is done via an API key which must be included in the request headers.</span>

<span class="sd">    This view will attempt to create a memory snapshot of the VM and then return it as a file download.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MemorySnapshotView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.MemorySnapshotView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the GET request to the MemorySnapshotView.</span>

<span class="sd">        The function will first authenticate the user using the API key provided in the headers.</span>
<span class="sd">        If the user is authenticated, it will proceed to create a memory snapshot of the VM</span>
<span class="sd">        specified by the UUID in the URL and then return the snapshot file as a response.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request.</span>
<span class="sd">            uuid: The UUID of the VM to create a memory snapshot of.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A FileResponse with the memory snapshot file. If an error occurs, a JsonResponse</span>
<span class="sd">            with an error message will be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">snapshot_file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory_snapshot</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">FileResponse</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">snapshot_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">snapshot_file</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span></div></div>

<div class="viewcode-block" id="DownloadScreenshotsView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadScreenshotsView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DownloadScreenshotsView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an API view for downloading all the screenshots of a Virtual Machine (VM) as a ZIP file.</span>
<span class="sd">    It requires the UUID of the VM to be specified as a path parameter in the URL.</span>

<span class="sd">    Authentication is done via an API key which must be included in the request headers.</span>

<span class="sd">    This view will attempt to collect all the screenshots of the VM, convert them to JPG format if necessary,</span>
<span class="sd">    compress them into a ZIP file, and then return it as a file download.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DownloadScreenshotsView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DownloadScreenshotsView.get">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the GET request to the DownloadScreenshotsView.</span>

<span class="sd">        The function will first authenticate the user using the API key provided in the headers.</span>
<span class="sd">        If the user is authenticated, it will proceed to collect all the screenshots of the VM specified by</span>
<span class="sd">        the UUID in the URL, convert them to JPG format, compress them into a ZIP file, and then return the</span>
<span class="sd">        ZIP file as a response.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The HTTP request.</span>
<span class="sd">            uuid: The UUID of the VM to download the screenshots from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A FileResponse with the ZIP file containing all screenshots. If an error occurs, a JsonResponse</span>
<span class="sd">            with an error message will be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">screenshots_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/screenshots/&quot;</span>

        <span class="c1"># Convert PNG files to JPG</span>
        <span class="k">for</span> <span class="n">png_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">screenshots_path</span><span class="si">}</span><span class="s2">/*.png&quot;</span><span class="p">):</span>
            <span class="n">jpg_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">png_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">png_file</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">jpg_file</span><span class="p">)</span>

        <span class="c1"># Create a zip file containing all JPG files</span>
        <span class="n">zip_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/screenshots.zip&quot;</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jpg_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">screenshots_path</span><span class="si">}</span><span class="s2">/*.jpg&quot;</span><span class="p">):</span>
                <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jpg_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">jpg_file</span><span class="p">))</span>

        <span class="c1"># Return the zip file as a FileResponse</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">FileResponse</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/zip&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">return</span> <span class="n">response</span></div></div>

<div class="viewcode-block" id="screendump"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.screendump">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">screendump</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Capture a screenshot of a Virtual Machine (VM) and save it as a PNG file.</span>

<span class="sd">    This function uses the QEMU Machine Protocol (QMP) to communicate with the VM and issue the &#39;screendump&#39; command,</span>
<span class="sd">    which captures a screenshot of the current state of the VM&#39;s display. The screenshot is saved to a directory</span>
<span class="sd">    named &#39;screenshots&#39; within the VM&#39;s directory, and the file is named &#39;sc&#39; followed by a five-digit number,</span>
<span class="sd">    with leading zeroes as necessary.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid: The UUID of the VM to capture a screenshot from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of the screenshot that was taken, as an integer.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Prints an exception error if the QMP connection or command execution fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>
    <span class="n">screenshots_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/screenshots/&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">screenshots_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">screenshots_path</span><span class="p">)</span>

    <span class="n">existing_screenshots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">screenshots_path</span><span class="si">}</span><span class="s2">/sc*.png&quot;</span><span class="p">))</span>
    <span class="n">next_screenshot_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_screenshots</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">next_screenshot_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sc</span><span class="si">{</span><span class="n">next_screenshot_number</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">next_screenshot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">screenshots_path</span><span class="p">,</span> <span class="n">next_screenshot_filename</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;screendump&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">next_screenshot_path</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Screenshot saved: </span><span class="si">{</span><span class="n">next_screenshot_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">next_screenshot_number</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>

<div class="viewcode-block" id="ScreenshotVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ScreenshotVMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ScreenshotVMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A View class to handle the capture of screenshots from a Virtual Machine (VM).</span>

<span class="sd">    This View supports an asynchronous POST request, which initiates the capture of a screenshot from the VM.</span>
<span class="sd">    The VM is identified by its UUID, which is passed in the URL.</span>

<span class="sd">    Authentication is required to access this View. It supports both session-based authentication and API key</span>
<span class="sd">    authentication.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>                <span class="c1"># ADDED</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ScreenshotVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ScreenshotVMView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles a POST request to capture a screenshot from a VM.</span>

<span class="sd">        The VM is identified by its UUID, which is passed in the URL.</span>

<span class="sd">        The request must be authenticated. This can be done either through session-based authentication or</span>
<span class="sd">        by including an &#39;X-API-KEY&#39; header in the request.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The Django request object.</span>
<span class="sd">            uuid: The UUID of the VM.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A JsonResponse containing the status of the screenshot operation. If the operation is successful,</span>
<span class="sd">            the response will include a &#39;screenshot_taken&#39; key with a value of True, and a &#39;message&#39; key with the</span>
<span class="sd">            screenshot number.</span>

<span class="sd">            If an error occurs, the JsonResponse will contain an &#39;error&#39; key with a description of the error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">)(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">screen_number</span> <span class="o">=</span> <span class="k">await</span> <span class="n">screendump</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;screenshot_taken&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">screen_number</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScreenshotVMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ScreenshotVMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to retrieve the authenticated user from the request, or return an error response if</span>
<span class="sd">        the request is not authenticated.</span>

<span class="sd">        The request can be authenticated either through session-based authentication or by including an</span>
<span class="sd">        &#39;X-API-KEY&#39; header in the request.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The Django request object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If the request is authenticated, returns a tuple where the first element is the authenticated user</span>
<span class="sd">            and the second element is None.</span>

<span class="sd">            If the request is not authenticated, returns a tuple where the first element is None and the second</span>
<span class="sd">            element is a JsonResponse with an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="system_shutdown"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.system_shutdown">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">system_shutdown</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sends a shutdown command to a VM specified by its UUID. It uses QEMU&#39;s QMP (QEMU Machine Protocol)</span>
<span class="sd">    to interact with the VM.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid (str): The UUID of the VM to be shutdown.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If there&#39;s an error while trying to interact with the VM, an exception will be raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;query-status&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VM status: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;system_powerdown&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>

<div class="viewcode-block" id="ShutdownVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ShutdownVMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ShutdownVMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django View handles POST requests to shutdown a VM. It authenticates the request and then uses the</span>
<span class="sd">    `system_shutdown` function to send a shutdown command to the VM.</span>

<span class="sd">    The VM is identified by its UUID, which should be included in the URL of the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ShutdownVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ShutdownVMView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the POST request to shut down a VM. It checks for user authentication, verifies the</span>
<span class="sd">        existence of the VM, and then sends the shutdown command.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (django.http.HttpRequest): The request instance.</span>
<span class="sd">            uuid (str): The UUID of the VM to be shutdown.</span>

<span class="sd">        Returns:</span>
<span class="sd">            django.http.JsonResponse: A JSON response with the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">)(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">system_shutdown</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vm_shutdown&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Shutdown command sent to VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShutdownVMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ShutdownVMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to retrieve the authenticated user from the request, or return an error response if</span>
<span class="sd">        the request is not authenticated.</span>

<span class="sd">        The request can be authenticated either through session-based authentication or by including an</span>
<span class="sd">        &#39;X-API-KEY&#39; header in the request.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The Django request object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If the request is authenticated, returns a tuple where the first element is the authenticated user</span>
<span class="sd">            and the second element is None.</span>

<span class="sd">            If the request is not authenticated, returns a tuple where the first element is None and the second</span>
<span class="sd">            element is a JsonResponse with an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="system_reset"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.system_reset">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">system_reset</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sends a reset command to a VM specified by its UUID. It uses QEMU&#39;s QMP (QEMU Machine Protocol)</span>
<span class="sd">    to interact with the VM.</span>

<span class="sd">    Args:</span>
<span class="sd">        uuid (str): The UUID of the VM to be reset.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If there&#39;s an error while trying to interact with the VM, an exception will be raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qmp</span> <span class="o">=</span> <span class="n">QMPClient</span><span class="p">(</span><span class="s1">&#39;forensicVM&#39;</span><span class="p">)</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/run/qmp.sock&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;query-status&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VM status: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;system_reset&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;suspended&#39;</span><span class="p">}:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;quit&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">qmp</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="ResetVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ResetVMView">[docs]</a><span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ResetVMView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django View handles POST requests to reset a VM. It authenticates the request and then uses the</span>
<span class="sd">    `system_reset` function to send a reset command to the VM.</span>

<span class="sd">    The VM is identified by its UUID, which should be included in the URL of the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ResetVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ResetVMView.post">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the POST request to reset a VM. It checks for user authentication, verifies the</span>
<span class="sd">        existence of the VM, and then sends the reset command.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (django.http.HttpRequest): The request instance.</span>
<span class="sd">            uuid (str): The UUID of the VM to be reset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            django.http.JsonResponse: A JSON response with the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">api_key_error</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_or_key_error</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_key_error</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">)(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">system_reset</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vm_reset&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Reset command sent to VM with UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResetVMView.get_user_or_key_error"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ResetVMView.get_user_or_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_or_key_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to retrieve the authenticated user from the request, or return an error response if</span>
<span class="sd">        the request is not authenticated.</span>

<span class="sd">        The request can be authenticated either through session-based authentication or by including an</span>
<span class="sd">        &#39;X-API-KEY&#39; header in the request.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The Django request object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If the request is authenticated, returns a tuple where the first element is the authenticated user</span>
<span class="sd">            and the second element is None.</span>

<span class="sd">            If the request is not authenticated, returns a tuple where the first element is None and the second</span>
<span class="sd">            element is a JsonResponse with an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="MountFolderView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.MountFolderView">[docs]</a><span class="k">class</span> <span class="nc">MountFolderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django View handles POST requests to mount a folder in a VM. It authenticates the request and then executes</span>
<span class="sd">    a mount command to bind the specified folder to a location within the VM&#39;s filesystem.</span>

<span class="sd">    The VM is identified by its UUID, which should be included in the URL of the request.</span>

<span class="sd">    The folder to be mounted should be specified in the request&#39;s JSON body using the &#39;folder&#39; key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MountFolderView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.MountFolderView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the POST request to mount a folder in a VM. It checks for user authentication, verifies the</span>
<span class="sd">        input folder path, and then sends the mount command.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (django.http.HttpRequest): The request instance.</span>
<span class="sd">            uuid (str): The UUID of the VM where the folder is to be mounted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            rest_framework.response.Response: A JSON response with the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">folder_to_mount</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_to_mount</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No folder specified to mount&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">mount_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/mnt&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mount_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mount --bind </span><span class="si">{</span><span class="n">folder_to_mount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mount_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;folder_mounted&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error mounting folder: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="DeleteVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DeleteVMView">[docs]</a><span class="k">class</span> <span class="nc">DeleteVMView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django View handles POST requests to delete a VM. It authenticates the request and then removes the specified VM&#39;s</span>
<span class="sd">    directory from the filesystem.</span>

<span class="sd">    The VM is identified by its UUID, which should be included in the URL of the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DeleteVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.DeleteVMView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the POST request to delete a VM. It checks for user authentication, verifies the</span>
<span class="sd">        existence of the VM, and then deletes the VM&#39;s directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (django.http.HttpRequest): The request instance.</span>
<span class="sd">            uuid (str): The UUID of the VM to be deleted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            rest_framework.response.Response: A JSON response with the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Path for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="c1"># Delete the VM directory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">vm_path</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vm_deleted&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vm_deleted&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CheckVMExistsView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckVMExistsView">[docs]</a><span class="k">class</span> <span class="nc">CheckVMExistsView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Django View handles GET requests to check if a VM exists. It authenticates the request and then checks the</span>
<span class="sd">    existence of the specified VM&#39;s directory in the filesystem.</span>

<span class="sd">    The VM is identified by its UUID, which should be included in the URL of the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CheckVMExistsView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CheckVMExistsView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the GET request to check if a VM exists. It checks for user authentication, verifies the</span>
<span class="sd">        existence of the VM, and then returns a JSON response with the result.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (django.http.HttpRequest): The request instance.</span>
<span class="sd">            uuid (str): The UUID of the VM to be checked.</span>

<span class="sd">        Returns:</span>
<span class="sd">            rest_framework.response.Response: A JSON response indicating whether the VM exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">/mode&quot;</span>
        <span class="n">vm_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vm_exists&#39;</span><span class="p">:</span> <span class="n">vm_exists</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="find_available_port"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.find_available_port">[docs]</a><span class="k">def</span> <span class="nf">find_available_port</span><span class="p">(</span><span class="n">start_port</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function finds two available, sequential TCP ports to use, starting from the given `start_port`.</span>

<span class="sd">    Args:</span>
<span class="sd">        start_port (int): The port number from which to start checking for availability.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A pair of two available, sequential TCP port numbers.</span>

<span class="sd">    Raises:</span>
<span class="sd">        OSError: If an error occurs that is not related to a port being in use (e.g., permission denied, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">start_port</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">98</span><span class="p">:</span>  <span class="c1"># &quot;Address already in use&quot;</span>
                    <span class="n">port</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="StopVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopVMView">[docs]</a><span class="k">class</span> <span class="nc">StopVMView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows VMs to be stopped via POST requests.</span>

<span class="sd">    This view accepts a POST request with a UUID and attempts to stop the corresponding screen session of the VM.</span>
<span class="sd">    If successful, it returns a 200 OK response with a JSON body indicating the VM has been stopped.</span>
<span class="sd">    If the screen session cannot be found, it returns a 404 Not Found error.</span>
<span class="sd">    An API key is required for authentication.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>                <span class="c1"># ADDED</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StopVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StopVMView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the VM specified by the UUID.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The POST request received by the server.</span>
<span class="sd">            uuid: The UUID of the VM to be stopped.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: A Django Response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Authenticate user using API key</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                       <span class="c1"># IF sync</span>
        <span class="c1">#user = await sync_to_async(getattr)(request, &#39;user&#39;, None)  # ASYNC: Get the user in the request</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>                          <span class="c1"># User is authenticated via session</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="k">pass</span>                                                    <span class="c1"># Add this extra block to the request</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>                                               <span class="c1"># &lt;--- Changed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Stop the screen session</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;screen -S </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2"> -X quit&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No screen session found for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="c1"># Check if the screen session was terminated</span>
        <span class="n">screen_status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;screen -list | grep </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">vm_stopped</span> <span class="o">=</span> <span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">screen_status</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vm_stopped&#39;</span><span class="p">:</span> <span class="n">vm_stopped</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StartVMView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StartVMView">[docs]</a><span class="k">class</span> <span class="nc">StartVMView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows VMs to be started via POST requests.</span>

<span class="sd">    This view accepts a POST request with a UUID and attempts to start the corresponding VM.</span>
<span class="sd">    If successful, it returns a 200 OK response with a JSON body indicating the VM has been started and provides the VNC and WebSocket ports.</span>
<span class="sd">    If the VM path or VNC script cannot be found, it returns a 404 Not Found error.</span>
<span class="sd">    An API key or session-based authentication is required.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>                <span class="c1"># ADDED</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StartVMView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.StartVMView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the VM specified by the UUID.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The POST request received by the server.</span>
<span class="sd">            uuid: The UUID of the VM to be started.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: A Django Response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                       <span class="c1"># IF sync</span>
        <span class="c1">#user = await sync_to_async(getattr)(request, &#39;user&#39;, None)  # ASYNC: Get the user in the request</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>                          <span class="c1"># User is authenticated via session</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="k">pass</span>                                                    <span class="c1"># Add this extra block to the request</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>                                               <span class="c1"># &lt;--- Changed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Path for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">vnc_scripts</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_path</span><span class="p">,</span> <span class="s1">&#39;*-vnc.sh&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vnc_scripts</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No VNC script found for UUID </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="n">recent_vnc_script</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vnc_scripts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>

        <span class="n">vnc_port</span><span class="p">,</span> <span class="n">websocket_port</span> <span class="o">=</span> <span class="n">find_available_port</span><span class="p">(</span><span class="mi">5900</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;screen -d -m -S </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2"> bash </span><span class="si">{</span><span class="n">recent_vnc_script</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">vnc_port</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">websocket_port</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">vm_path</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">run_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_path</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
        <span class="n">pid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="s2">&quot;run.pid&quot;</span><span class="p">)</span>
        <span class="n">vm_running</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ps -ef | grep </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;vm_running&#39;</span><span class="p">:</span> <span class="n">vm_running</span><span class="p">,</span>
            <span class="s1">&#39;vnc_port&#39;</span><span class="p">:</span> <span class="n">vnc_port</span><span class="p">,</span>
            <span class="s1">&#39;websocket_port&#39;</span><span class="p">:</span> <span class="n">websocket_port</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ForensicImageVMStatus"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ForensicImageVMStatus">[docs]</a><span class="k">class</span> <span class="nc">ForensicImageVMStatus</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows retrieval of the status of a forensic image VM via GET requests.</span>

<span class="sd">    This view accepts a GET request with a UUID and returns the status of the corresponding forensic image VM.</span>
<span class="sd">    If the VM path or mode file cannot be found, it returns a 404 Not Found error.</span>
<span class="sd">    An API key or session-based authentication is required.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>                <span class="c1"># ADDED</span>
    <span class="c1">#authentication_classes = []</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ForensicImageVMStatus.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ForensicImageVMStatus.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the status of the forensic image VM specified by the UUID.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The GET request received by the server.</span>
<span class="sd">            uuid: The UUID of the forensic image VM.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: A Django Response object containing the VM status and related information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                       <span class="c1"># IF sync</span>
        <span class="c1">#user = await sync_to_async(getattr)(request, &#39;user&#39;, None)  # ASYNC: Get the user in the request</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>                          <span class="c1"># User is authenticated via session</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: USER AUTHENTICATED&quot;</span><span class="p">)</span>
            <span class="k">pass</span>                                                    <span class="c1"># Add this extra block to the request</span>
        <span class="k">elif</span> <span class="n">api_key</span><span class="p">:</span>                                               <span class="c1"># &lt;--- Changed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="n">vm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/forensicVM/mnt/vm/</span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">run_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_path</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
        <span class="n">pid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="s2">&quot;run.pid&quot;</span><span class="p">)</span>
        <span class="n">mode_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_path</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span>

        <span class="c1">#if not os.path.exists(mode_file):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vm_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Does no exist&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;not_exist&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;exists&#39;</span><span class="p">}</span>

            <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mode_file</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mode_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;running_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ps -ef | grep </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> | grep </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vm_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span>


                    <span class="n">qemu_cmd</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">vnc_port</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-display vnc=0.0.0.0:(\d+)&#39;</span><span class="p">,</span> <span class="n">qemu_cmd</span><span class="p">)</span>
                    <span class="n">websocket_port</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;,websocket=(\d+)&#39;</span><span class="p">,</span> <span class="n">qemu_cmd</span><span class="p">)</span>
                    <span class="n">qmp_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-qmp unix:([^,]+)&#39;</span><span class="p">,</span> <span class="n">qemu_cmd</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">vnc_port</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vnc_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vnc_port</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vm_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stopped&#39;</span>
                    <span class="k">if</span> <span class="n">websocket_port</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;websocket_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">websocket_port</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vm_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stopped&#39;</span>
                    <span class="k">if</span> <span class="n">qmp_file</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;qmp_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qmp_file</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vm_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stopped&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vm_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stopped&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;vm_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stopped&#39;</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CreateSshKeysView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CreateSshKeysView">[docs]</a><span class="k">class</span> <span class="nc">CreateSshKeysView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows the creation of SSH keys by adding a public key to the authorized keys file of the forensic investigator user.</span>

<span class="sd">    This view accepts a POST request with a public key as a parameter. The public key is added to the authorized keys file of the forensic investigator user.</span>
<span class="sd">    An API key or session-based authentication is required.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CreateSshKeysView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.CreateSshKeysView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a public key to the authorized keys file of the forensic investigator user.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The POST request received by the server.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: A Django Response object containing the result of adding the public key to the authorized keys file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="c1"># Read public key from request data</span>
        <span class="n">public_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;public_key&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">public_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing public key parameter&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># Check if public key already exists in authorized keys</span>
        <span class="n">authorized_keys_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/home/forensicinvestigator/.ssh/authorized_keys&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">authorized_keys_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">authorized_keys</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">public_key</span> <span class="ow">in</span> <span class="n">authorized_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Public key already added to authorized keys&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="c1"># Add public key to authorized keys of the forensicinvestigator user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">authorized_keys_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">public_key</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to append public key to authorized keys file&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Public key added to authorized keys&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ProtectedView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ProtectedView">[docs]</a><span class="k">class</span> <span class="nc">ProtectedView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that creates a protected view requiring an API key for access.</span>

<span class="sd">    This view accepts a GET request and checks for the presence of an API key in the request headers.</span>
<span class="sd">    If a valid API key is found, the access is granted and a success message is returned.</span>
<span class="sd">    An API key is required for accessing this view.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ProtectedView.get"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.ProtectedView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the GET request and checks for the presence of a valid API key.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The GET request received by the server.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: A Django Response object indicating the result of the access check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User account is disabled.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Access granted&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="RunScriptView"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RunScriptView">[docs]</a><span class="k">class</span> <span class="nc">RunScriptView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint for running a script.</span>

<span class="sd">    This view accepts a POST request and expects an API key to be provided in the request headers.</span>
<span class="sd">    The request should contain a &#39;script&#39; parameter in the data payload, which contains the script to be executed.</span>
<span class="sd">    The script is executed using the subprocess module, and the output and error code are returned in the response.</span>

<span class="sd">    Note: This view does not perform any authentication or permission checks beyond validating the API key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RunScriptView.post"><a class="viewcode-back" href="../../apikeys.html#apikeys.views.RunScriptView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the POST request to execute a script.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: The POST request received by the server.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: A Django Response object containing the script output and error code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_API_KEY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ApiKey</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;API key required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;script&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing script parameter&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">script</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s1">&#39;error_code&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="s1">&#39;error_code&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Nuno Mourinho.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>